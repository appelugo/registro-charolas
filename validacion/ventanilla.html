<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Ventanilla - Validador de Charolas</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
        :root {
            --primary:#0A2342; --secondary:#2C4C6B; --accent:#4A89C5; --light:#F5F9FF;
            --white:#fff; --gray:#E8EEF2; --text-dark:#1E2B3C; --success:#27AE60;
            --danger:#E74C3C; --warning:#F39C12; --dominos:#00A5B0; --starbucks:#006241;
            --border-radius:6px;
        }
        body { background:var(--gray); color:var(--text-dark); line-height:1.3; padding:12px; min-height:100vh; }
        .container {
            max-width:1400px; margin:0 auto; background:var(--white); border-radius:var(--border-radius);
            box-shadow:0 2px 6px rgba(10,35,66,0.08); padding:15px; display:flex; flex-direction:column;
            height:calc(100vh - 24px);
        }
        .header-fijo { flex-shrink:0; background:var(--white); padding-bottom:6px; border-bottom:2px solid var(--accent); margin-bottom:8px; }
        .header-superior { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
        .header-left { display:flex; align-items:center; gap:10px; }
        .logo-small { height:35px; width:auto; }
        .header-left h1 { color:var(--primary); font-size:1.2rem; }
        .header-left h1 span { color:var(--accent); font-weight:300; }
        .header-derecha { display:flex; align-items:center; gap:10px; }
        .user-info { display:flex; align-items:center; gap:12px; background:var(--light); padding:4px 12px; border-radius:30px; border-left:4px solid var(--accent); }
        .user-empleado { font-weight:600; color:var(--primary); font-size:0.8rem; }
        .btn-validar-header { background:var(--warning); color:white; border:none; border-radius:5px; padding:6px 18px; font-weight:700; font-size:0.8rem; text-transform:uppercase; cursor:pointer; }
        .btn-validar-header:hover { background:#E67E22; }
        .btn-validar-header:disabled { background:#95A5A6; cursor:not-allowed; }
        .btn-agregar { background:var(--success); color:white; border:none; border-radius:5px; padding:6px 15px; font-weight:600; font-size:0.75rem; cursor:pointer; margin-left:10px; }
        .btn-agregar:hover { background:#219A53; }
        .btn-agregar:disabled { background:#95A5A6; cursor:not-allowed; }
        .btn { padding:4px 10px; border:none; border-radius:5px; font-weight:600; font-size:0.7rem; text-transform:uppercase; cursor:pointer; }
        .btn-primary { background:var(--primary); color:white; }
        .btn-danger { background:var(--danger); color:white; }
        .form-principal { background:linear-gradient(to right,var(--light),var(--white)); padding:8px 12px; border-radius:8px; margin-bottom:8px; border:1px solid rgba(74,137,197,0.15); }
        .fila-campos { display:grid; grid-template-columns:1.2fr 0.9fr 0.9fr 0.7fr 0.9fr 0.9fr; gap:6px; align-items:center; margin-bottom:6px; }
        .campo-group { display:flex; flex-direction:column; }
        .campo-group label { font-weight:600; color:var(--primary); margin-bottom:1px; font-size:0.6rem; text-transform:uppercase; }
        .campo-group input, .campo-group .valor { 
            padding:4px 8px; border:1.5px solid var(--gray); border-radius:5px; font-size:0.8rem; 
            background:var(--white); height:30px; text-transform:uppercase; 
        }
        .campo-group .valor { background:#F0F4F8; display:flex; align-items:center; text-transform:uppercase; }
        .campo-group.check-group { display:flex; flex-direction:column; gap:4px; }
        .campo-group.check-group label { display:flex; align-items:center; gap:4px; font-size:0.7rem; text-transform:none; }
        .campo-group input:read-only { background:#F0F4F8; color:var(--text-dark); border-color:#D5DBDB; }
        .busqueda-integrada { display:flex; gap:3px; align-items:flex-end; }
        .busqueda-integrada .campo-group { flex:1; }
        .btn-lupa { background:var(--accent); color:white; border:none; border-radius:5px; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:0.9rem; }
        .fila-comentario { margin-top:6px; }
        .fila-comentario .campo-group { width:100%; }
        .fila-comentario input { width:100%; height:34px; }
        .validado-message { background:rgba(39,174,96,0.1); color:var(--success); padding:6px 12px; border-radius:5px; border-left:4px solid var(--success); margin-bottom:10px; font-weight:600; font-size:0.8rem; }
        .mensaje-error { color:var(--danger); font-size:0.75rem; margin:8px 0; padding:6px 10px; background:rgba(231,76,60,0.05); border-radius:5px; border-left:4px solid var(--danger); }
        
        /* Totales estilo formulario */
        .totals-compact {
            display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-left:15px;
        }
        .total-item {
            display:flex; align-items:center; gap:6px; background:var(--light); 
            padding:4px 12px; border-radius:30px; border-left:4px solid;
            box-shadow:0 2px 4px rgba(0,0,0,0.02); font-size:0.75rem;
        }
        .total-item.dominos { border-left-color:var(--dominos); }
        .total-item.starbucks { border-left-color:var(--starbucks); }
        .total-item.dominos .total-number { color:var(--dominos); font-weight:700; margin-left:3px; }
        .total-item.starbucks .total-number { color:var(--starbucks); font-weight:700; margin-left:3px; }
        .total-label { font-size:0.7rem; text-transform:uppercase; font-weight:600; color:var(--secondary); }
        
        .tabla-section { margin-top:10px; }
        .table-responsive { overflow-x:auto; border-radius:6px; border:1px solid var(--gray); max-height:400px; overflow-y:auto; }
        table { width:100%; border-collapse:collapse; table-layout:auto; min-width:1200px; }
        th { background:var(--primary); color:white; padding:6px 4px; font-size:0.65rem; text-transform:uppercase; text-align:center; position:sticky; top:0; z-index:10; }
        td { padding:5px 4px; border-bottom:1px solid var(--gray); text-align:center; font-size:0.75rem; }
        .table-input { 
            width:100%; padding:4px 6px; border:1.5px solid var(--gray); border-radius:4px; 
            font-size:0.75rem; text-align:center; background:var(--white); text-transform:uppercase; 
        }
        .table-input:focus { outline:none; border-color:var(--accent); }
        .table-input:disabled { background:#F0F4F8; border-color:#D5DBDB; }
        .table-input:read-only { background:#F0F4F8; border-color:#D5DBDB; cursor:default; }
        .table-input.valido { border-left:4px solid var(--success); border-color:var(--success); background:rgba(39,174,96,0.05); }
        .table-input.error { border-left:4px solid var(--danger); border-color:var(--danger); background:rgba(231,76,60,0.05); }
        .badge { padding:2px 6px; border-radius:50px; font-weight:600; font-size:0.6rem; display:inline-block; text-transform:uppercase; }
        .badge-dominos { background:rgba(0,165,176,0.1); color:#00A5B0; border:1px solid #00A5B0; }
        .badge-starbucks { background:rgba(0,98,65,0.1); color:#006241; border:1px solid #006241; }
        .loader-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(10,35,66,0.7); display:none; justify-content:center; align-items:center; z-index:20000; }
        .loader-container { background:white; padding:15px 25px; border-radius:10px; text-align:center; }
        .loader-spinner { width:35px; height:35px; border:3px solid var(--light); border-top:3px solid var(--accent); border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px; }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        .footer { margin-top:10px; color:var(--secondary); font-size:0.6rem; text-align:right; border-top:1px solid var(--gray); padding-top:6px; }
        .tabla-header { display:flex; align-items:center; margin:10px 0 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-fijo">
            <div class="header-superior">
                <div class="header-left">
                    <img src="logo.png" class="logo-small" onerror="this.style.display='none'">
                    <h1>Ventanilla de <span>Validaci√≥n</span></h1>
                </div>
                <div class="header-derecha">
                    <div class="user-info" id="userInfo" style="display:none;">
                        <span class="user-empleado" id="userEmpleado"></span>
                        <button class="btn btn-danger" onclick="cerrarSesion()">SALIR</button>
                    </div>
                    <div id="loginButtons">
                        <button class="btn btn-primary" onclick="window.location.href='login.html'">ACCEDER</button>
                    </div>
                    <button class="btn-validar-header" id="btnValidar" onclick="guardarValidacion()">‚úÖ VALIDAR</button>
                </div>
            </div>
            <div class="form-principal">
                <div class="fila-campos">
                    <!-- Col 1: B√∫squeda -->
                    <div class="busqueda-integrada">
                        <div class="campo-group"><label>üîç BIT√ÅCORA</label><input type="text" id="buscarBitacora" placeholder="N√öMERO" onkeypress="if(event.key==='Enter'){buscarRegistro();}" oninput="this.value=this.value.toUpperCase()"></div>
                        <button class="btn-lupa" onclick="buscarRegistro()">üîç</button>
                    </div>
                    <!-- Col 2: TRANSPORTE -->
                    <div class="campo-group"><label>TRANSPORTE</label><input type="text" id="transporte" placeholder="TRANSPORTE" oninput="this.value=this.value.toUpperCase()"></div>
                    <!-- Col 3: CHECKBOX en columna -->
                    <div class="campo-group check-group">
                        <label><input type="checkbox" id="firmada" checked> FIRMADA</label>
                        <label><input type="checkbox" id="sellada" checked> SELLADA</label>
                    </div>
                    <!-- Col 4: FECHA DE BIT√ÅCORA -->
                    <div class="campo-group"><label>FECHA DE BIT√ÅCORA</label><input type="date" id="fechaBitacora"></div>
                    <!-- Col 5: OPERADOR -->
                    <div class="campo-group"><label>OPERADOR</label><input type="text" id="noOperador" placeholder="OPERADOR" oninput="this.value=this.value.toUpperCase()"></div>
                    <!-- Col 6: VIAJE -->
                    <div class="campo-group"><label>VIAJE</label><input type="text" id="noViaje" placeholder="VIAJE" oninput="this.value=this.value.toUpperCase()"></div>
                </div>
                <!-- Campo COMENTARIOS ocupa ancho completo -->
                <div class="fila-comentario">
                    <div class="campo-group"><label>COMENTARIOS</label><input type="text" id="comentariosValidacion" placeholder="OBSERVACIONES DE VALIDACI√ìN" oninput="this.value=this.value.toUpperCase()"></div>
                </div>
            </div>
        </div>
        <div style="flex:1; overflow-y:auto; padding-right:5px;">
            <div id="validadoMessage" class="validado-message" style="display:none;">‚úÖ ESTA BIT√ÅCORA YA FUE VALIDADA</div>
            <div id="mensajeError" class="mensaje-error" style="display:none;"></div>
            
            <!-- DATOS DE BIT√ÅCORA (solo lectura o editables seg√∫n caso) -->
            <div class="form-principal" id="datosBitacora" style="display:none;">
                <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:6px;">
                    <div class="campo-group">
                        <label>NO. EMPLEADO</label>
                        <input type="text" id="editNoEmpleado" class="table-input" placeholder="NO. EMPLEADO" value="" oninput="this.value=this.value.toUpperCase()">
                    </div>
                    <div class="campo-group">
                        <label>RUTA</label>
                        <input type="text" id="editRuta" class="table-input" placeholder="RUTA" value="" oninput="this.value=this.value.toUpperCase()">
                    </div>
                    <div class="campo-group">
                        <label>BIT√ÅCORA</label>
                        <div class="valor" id="verBitacora">‚Äî</div>
                    </div>
                    <div class="campo-group">
                        <label>UNIDAD</label>
                        <input type="text" id="editUnidad" class="table-input" placeholder="UNIDAD" value="" oninput="this.value=this.value.toUpperCase()">
                    </div>
                </div>
            </div>

            <!-- CABECERA DE TABLA CON BOT√ìN AGREGAR Y TOTALES -->
            <div class="tabla-header">
                <h3 style="color:var(--primary); font-size:1rem;">üìã VALIDACI√ìN DE TIENDAS</h3>
                <div class="totals-compact" id="totalesContainer">
                    <div class="total-item dominos">
                        <span class="total-label">DOMINO'S</span>
                        <span class="total-number" id="totalDominos">0</span>
                    </div>
                    <div class="total-item starbucks">
                        <span class="total-label">STARBUCKS</span>
                        <span class="total-number" id="totalStarbucks">0</span>
                    </div>
                </div>
                <button class="btn-agregar" onclick="agregarFilasTiendas()" id="btnAgregarTiendas" style="margin-left:auto;">‚ûï AGREGAR 5 TIENDAS</button>
            </div>

            <!-- TABLA DE TIENDAS -->
            <div id="tablaSection" style="display:block;" class="tabla-section">
                <div class="table-responsive">
                    <table id="tablaTiendas">
                        <thead>
                            <tr>
                                <th>CECO</th>
                                <th>NOMBRE TIENDA</th>
                                <th>MARCA</th>
                                <th>REMISI√ìN</th>
                                <th>COMPLEMENTO</th>
                                <th>CANTIDAD</th>
                                <th>DIFERENCIA</th>
                                <th>CNT. F√çSICA</th>
                            </tr>
                        </thead>
                        <tbody id="tablaBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="footer">SISTEMA DE VALIDACI√ìN V2.0 | E.LUGO 2026</div>
    </div>
    <div id="loaderOverlay" class="loader-overlay"><div class="loader-container"><div class="loader-spinner"></div><div class="loader-text">PROCESANDO...</div></div></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDD0lCq8rAnCm2KjsqSwzxlpUhQU2gRVfk",
            authDomain: "registro-charolas.firebaseapp.com",
            projectId: "registro-charolas",
            storageBucket: "registro-charolas.firebasestorage.app",
            messagingSenderId: "105080206085",
            appId: "1:105080206085:web:443ba22aaf8cbcea767d6c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let registroActual = null;
        let documentoIdActual = null;
        let datosOrganigrama = [];
        let esModoEdicion = true;
        let esNuevoRegistro = false;

        document.addEventListener('DOMContentLoaded', function() {
            const nombre = sessionStorage.getItem('usuarioNombre');
            const emp = sessionStorage.getItem('usuarioEmpleado');
            if (nombre) document.getElementById('userEmpleado').textContent = nombre.toUpperCase();
            else if (emp) document.getElementById('userEmpleado').textContent = emp.toUpperCase();
            else document.getElementById('userEmpleado').textContent = 'USUARIO';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('loginButtons').style.display = 'none';
            cargarOrganigrama();
            inicializarTablaVacia();
        });

        function cerrarSesion() { sessionStorage.clear(); window.location.href = 'login.html'; }

        async function cargarOrganigrama() {
            try {
                const snap = await db.collection('organigrama').doc('lista_cecos').get();
                if (snap.exists) datosOrganigrama = snap.data().datosCompletos || [];
                console.log('‚úÖ ORGANIGRAMA CARGADO:', datosOrganigrama.length);
            } catch (e) { datosOrganigrama = []; }
        }

        function obtenerDatosTienda(ceco) {
            if (!datosOrganigrama.length) return { nombre: '', marca: '' };
            const t = datosOrganigrama.find(i => String(i.ceco).trim() === String(ceco).trim());
            return t ? { nombre: (t.tienda || '').toUpperCase(), marca: (t.marca || '').toUpperCase() } : { nombre: '', marca: '' };
        }

        function actualizarTotales() {
            let totalDominos = 0;
            let totalStarbucks = 0;
            
            document.querySelectorAll('#tablaBody tr').forEach(fila => {
                const inputs = fila.querySelectorAll('input');
                if (inputs.length > 0) {
                    const ceco = inputs[0]?.value.trim().toUpperCase() || '';
                    if (ceco) {
                        const datos = obtenerDatosTienda(ceco);
                        if (datos.marca.includes('DOMINO')) totalDominos++;
                        else if (datos.marca.includes('STARBUCKS') || datos.marca.includes('CHILIS')) totalStarbucks++;
                    }
                }
            });
            
            document.getElementById('totalDominos').textContent = totalDominos;
            document.getElementById('totalStarbucks').textContent = totalStarbucks;
        }

        function validarTienda(input) {
            const ceco = input.value.trim().toUpperCase();
            if (!ceco) {
                input.classList.remove('valido', 'error');
                const fila = input.closest('tr');
                if (fila) {
                    fila.cells[1].innerHTML = '<span class="texto-tabla"></span>';
                    fila.cells[2].innerHTML = '<span class="badge"></span>';
                }
                actualizarTotales();
                return;
            }

            const datos = obtenerDatosTienda(ceco);
            const fila = input.closest('tr');
            
            if (datos.nombre || datos.marca) {
                input.classList.add('valido');
                input.classList.remove('error');
                if (fila) {
                    fila.cells[1].innerHTML = `<span class="texto-tabla">${datos.nombre}</span>`;
                    
                    let badgeClass = '';
                    if (datos.marca.includes('DOMINO')) badgeClass = 'badge-dominos';
                    else if (datos.marca.includes('STARBUCKS') || datos.marca.includes('CHILIS')) badgeClass = 'badge-starbucks';
                    
                    fila.cells[2].innerHTML = `<span class="badge ${badgeClass}">${datos.marca}</span>`;
                }
            } else {
                input.classList.add('error');
                input.classList.remove('valido');
                if (fila) {
                    fila.cells[1].innerHTML = '<span class="texto-tabla" style="color:var(--danger);">NO ENCONTRADO</span>';
                    fila.cells[2].innerHTML = '<span class="badge"></span>';
                }
            }
            actualizarTotales();
        }

        function inicializarTablaVacia() {
            const tbody = document.getElementById('tablaBody');
            tbody.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                agregarFilaTienda(true);
            }
            actualizarTotales();
        }

        function agregarFilaTienda(esNueva = true) {
            const tbody = document.getElementById('tablaBody');
            const fila = document.createElement('tr');
            const modoLectura = !esNueva && !esNuevoRegistro && registroActual;
            
            fila.innerHTML = `
                <td><input type="text" class="table-input" placeholder="CECO" onblur="validarTienda(this)" oninput="this.value=this.value.toUpperCase()" ${modoLectura ? 'readonly' : ''}></td>
                <td><span class="texto-tabla"></span></td>
                <td><span class="badge"></span></td>
                <td><input type="text" class="table-input" placeholder="REMISI√ìN" oninput="this.value=this.value.toUpperCase()"></td>
                <td><input type="text" class="table-input" placeholder="COMPLEMENTO" oninput="this.value=this.value.toUpperCase()"></td>
                <td>0</td>
                <td>0</td>
                <td><strong>0</strong></td>
            `;
            tbody.appendChild(fila);
        }

        function agregarFilasTiendas() {
            if (!esModoEdicion) return;
            for (let i = 0; i < 5; i++) {
                agregarFilaTienda(true);
            }
            actualizarTotales();
        }

        function limpiarTodoDespuesGuardar() {
            document.getElementById('buscarBitacora').value = '';
            document.getElementById('transporte').value = '';
            document.getElementById('firmada').checked = true;
            document.getElementById('sellada').checked = true;
            document.getElementById('fechaBitacora').value = '';
            document.getElementById('noOperador').value = '';
            document.getElementById('noViaje').value = '';
            document.getElementById('comentariosValidacion').value = '';
            
            document.getElementById('datosBitacora').style.display = 'none';
            document.getElementById('validadoMessage').style.display = 'none';
            
            inicializarTablaVacia();
            
            esNuevoRegistro = false;
            registroActual = null;
            documentoIdActual = null;
            document.getElementById('btnAgregarTiendas').disabled = false;
        }

        function habilitarCamposNuevoRegistro(bitacora) {
            document.getElementById('editNoEmpleado').value = '';
            document.getElementById('editRuta').value = '';
            document.getElementById('verBitacora').textContent = bitacora;
            document.getElementById('editUnidad').value = '';
            
            // HABILITAR campos para edici√≥n
            document.getElementById('editNoEmpleado').readOnly = false;
            document.getElementById('editRuta').readOnly = false;
            document.getElementById('editUnidad').readOnly = false;
            
            document.getElementById('editNoEmpleado').classList.remove('valor');
            document.getElementById('editRuta').classList.remove('valor');
            document.getElementById('editUnidad').classList.remove('valor');
        }

        function deshabilitarCamposExistente() {
            document.getElementById('editNoEmpleado').readOnly = true;
            document.getElementById('editRuta').readOnly = true;
            document.getElementById('editUnidad').readOnly = true;
            
            document.getElementById('editNoEmpleado').classList.add('valor');
            document.getElementById('editRuta').classList.add('valor');
            document.getElementById('editUnidad').classList.add('valor');
        }

        async function buscarRegistro() {
            const bitacora = document.getElementById('buscarBitacora').value.trim().toUpperCase();
            
            if (!bitacora) {
                mostrarError('‚ö†Ô∏è INGRESA N√öMERO DE BIT√ÅCORA');
                return;
            }

            mostrarLoader();
            try {
                const snapshot = await db.collection('registros')
                    .where('datosGenerales.bitacora', '==', bitacora)
                    .get();

                if (snapshot.empty) {
                    ocultarLoader();
                    // NUEVO REGISTRO - TODOS LOS CAMPOS HABILITADOS
                    esNuevoRegistro = true;
                    esModoEdicion = true;
                    document.getElementById('validadoMessage').style.display = 'none';
                    document.getElementById('btnValidar').disabled = false;
                    document.getElementById('btnAgregarTiendas').disabled = false;
                    
                    document.getElementById('datosBitacora').style.display = 'block';
                    habilitarCamposNuevoRegistro(bitacora);
                    
                    inicializarTablaVacia();
                    
                    mostrarError('üìù NO EXISTE. PUEDES CREAR UN NUEVO REGISTRO.');
                    registroActual = null;
                    documentoIdActual = null;
                    return;
                }

                // REGISTRO EXISTENTE
                snapshot.forEach(doc => {
                    registroActual = doc.data();
                    documentoIdActual = doc.id;
                });

                document.getElementById('editNoEmpleado').value = (registroActual.datosGenerales?.noEmpleado || '').toUpperCase();
                document.getElementById('editRuta').value = (registroActual.datosGenerales?.ruta || '').toUpperCase();
                document.getElementById('verBitacora').textContent = (registroActual.datosGenerales?.bitacora || '').toUpperCase();
                document.getElementById('editUnidad').value = (registroActual.datosGenerales?.unidad || '').toUpperCase();
                document.getElementById('datosBitacora').style.display = 'block';
                
                deshabilitarCamposExistente();

                if (registroActual.validacion) {
                    esModoEdicion = false;
                    document.getElementById('validadoMessage').style.display = 'block';
                    document.getElementById('btnValidar').disabled = true;
                    document.getElementById('btnAgregarTiendas').disabled = true;
                    bloquearCampos(true);
                    cargarDatosValidacion(registroActual);
                } else {
                    esModoEdicion = true;
                    document.getElementById('validadoMessage').style.display = 'none';
                    document.getElementById('btnValidar').disabled = false;
                    document.getElementById('btnAgregarTiendas').disabled = false;
                    bloquearCampos(false);
                }

                mostrarRegistroExistente(registroActual);
                ocultarError();
                actualizarTotales();

            } catch (e) { 
                mostrarError('‚ùå ERROR: ' + e.message); 
            } finally { 
                ocultarLoader(); 
            }
        }

        function mostrarRegistroExistente(r) {
            const tbody = document.getElementById('tablaBody');
            tbody.innerHTML = '';

            if (r.registros && r.registros.length) {
                r.registros.forEach((t, i) => {
                    const d = obtenerDatosTienda(t.tienda);
                    const badge = d.marca.includes('DOMINO') ? 'badge-dominos' : 'badge-starbucks';
                    const rem = (r.validacion?.tiendas?.[i]?.remision || '').toUpperCase();
                    const com = (r.validacion?.tiendas?.[i]?.complemento || '').toUpperCase();
                    const fila = document.createElement('tr');
                    fila.innerHTML = `
                        <td><input type="text" class="table-input" value="${(t.tienda||'').toUpperCase()}" placeholder="CECO" readonly onblur="validarTienda(this)" oninput="this.value=this.value.toUpperCase()"></td>
                        <td><span class="texto-tabla">${d.nombre}</span></td>
                        <td><span class="badge ${badge}">${d.marca}</span></td>
                        <td><input type="text" class="table-input" value="${rem}" placeholder="REMISI√ìN" ${!esModoEdicion ? 'disabled' : ''} oninput="this.value=this.value.toUpperCase()"></td>
                        <td><input type="text" class="table-input" value="${com}" placeholder="COMPLEMENTO" ${!esModoEdicion ? 'disabled' : ''} oninput="this.value=this.value.toUpperCase()"></td>
                        <td>${t.cantidadBitacora||0}</td>
                        <td>${t.diferencia||0}</td>
                        <td><strong>${t.cantidadFisica||0}</strong></td>
                    `;
                    tbody.appendChild(fila);
                });
            }
            if (r.validacion) cargarDatosValidacion(r);
            actualizarTotales();
        }

        function bloquearCampos(b) {
            const campos = ['transporte','firmada','sellada','fechaBitacora','noOperador','noViaje','comentariosValidacion'];
            campos.forEach(id => { const el = document.getElementById(id); if(el) el.disabled = b; });
        }

        function cargarDatosValidacion(r) {
            if (r.validacion) {
                document.getElementById('transporte').value = (r.validacion.transporte||'').toUpperCase();
                document.getElementById('firmada').checked = r.validacion.firmada||false;
                document.getElementById('sellada').checked = r.validacion.sellada||false;
                document.getElementById('fechaBitacora').value = r.validacion.fechaBitacora||'';
                document.getElementById('noOperador').value = (r.validacion.noOperador||'').toUpperCase();
                document.getElementById('noViaje').value = (r.validacion.noViaje||'').toUpperCase();
                document.getElementById('comentariosValidacion').value = (r.validacion.comentarios||'').toUpperCase();
            }
        }

        async function guardarValidacion() {
            mostrarLoader('GUARDANDO...');
            
            try {
                const tiendas = [];
                const filas = document.querySelectorAll('#tablaBody tr');
                let totalDominos = 0;
                let totalStarbucks = 0;

                filas.forEach((fila) => {
                    const inputs = fila.querySelectorAll('input');
                    const ceco = inputs[0]?.value.trim().toUpperCase() || '';
                    if (!ceco) return;

                    const remision = inputs[3]?.value.trim().toUpperCase() || '';
                    const complemento = inputs[4]?.value.trim().toUpperCase() || '';
                    
                    const datos = obtenerDatosTienda(ceco);
                    
                    tiendas.push({
                        tienda: ceco,
                        cantidadBitacora: 0,
                        diferencia: 0,
                        cantidadFisica: 0,
                        tipo: datos.marca || '',
                        remision,
                        complemento
                    });

                    if (datos.marca?.includes('DOMINO')) totalDominos++;
                    else if (datos.marca?.includes('STARBUCKS') || datos.marca?.includes('CHILIS')) totalStarbucks++;
                });

                const nombreValidador = (sessionStorage.getItem('usuarioNombre') || sessionStorage.getItem('usuarioEmpleado') || 'VALIDADOR').toUpperCase();
                const fechaActual = new Date().toLocaleString();
                const fechaValidacion = new Date().toISOString().split('T')[0];

                const comentarioExistente = (registroActual?.datosGenerales?.comentarios || '').toUpperCase();
                const comentarioNuevo = document.getElementById('comentariosValidacion').value.trim().toUpperCase();
                let comentarioFinal = comentarioExistente;
                if (comentarioNuevo) {
                    comentarioFinal = comentarioExistente 
                        ? `${comentarioExistente} | [VALIDACI√ìN ${fechaActual} POR ${nombreValidador}: ${comentarioNuevo}]`
                        : `[VALIDACI√ìN ${fechaActual} POR ${nombreValidador}: ${comentarioNuevo}]`;
                }

                const datosGenerales = {
                    noEmpleado: document.getElementById('editNoEmpleado').value.trim().toUpperCase() || 'S/N',
                    ruta: document.getElementById('editRuta').value.trim().toUpperCase() || 'S/N',
                    bitacora: document.getElementById('verBitacora').textContent || 'S/N',
                    unidad: document.getElementById('editUnidad').value.trim().toUpperCase() || 'S/N',
                    comentarios: comentarioFinal
                };

                const resumen = {
                    totalTiendas: tiendas.length,
                    totalDominos: totalDominos,
                    totalStarbucks: totalStarbucks
                };

                const validacionData = {
                    validador: nombreValidador,
                    transporte: document.getElementById('transporte').value.trim().toUpperCase() || '',
                    firmada: document.getElementById('firmada').checked,
                    sellada: document.getElementById('sellada').checked,
                    fechaBitacora: document.getElementById('fechaBitacora').value || fechaValidacion,
                    noOperador: document.getElementById('noOperador').value.trim().toUpperCase() || '',
                    noViaje: document.getElementById('noViaje').value.trim().toUpperCase() || '',
                    comentarios: comentarioNuevo,
                    tiendas: tiendas.map(t => ({ remision: t.remision, complemento: t.complemento })),
                    fechaValidacion: fechaActual,
                    validadoPor: nombreValidador
                };

                if (esNuevoRegistro) {
                    const idUnico = Date.now() + '-' + Math.random().toString(36).substr(2, 8);
                    const nuevoRegistro = {
                        id: idUnico,
                        fechaCaptura: fechaActual,
                        turno: obtenerTurnoActual(),
                        datosGenerales: datosGenerales,
                        totales: {
                            dominos: totalDominos.toString(),
                            starbucks: totalStarbucks.toString()
                        },
                        registros: tiendas.map(t => ({
                            tienda: t.tienda,
                            cantidadBitacora: t.cantidadBitacora,
                            diferencia: t.diferencia,
                            cantidadFisica: t.cantidadFisica,
                            tipo: t.tipo
                        })),
                        resumen: resumen,
                        validacion: validacionData
                    };
                    
                    await db.collection('registros').doc(idUnico).set(nuevoRegistro);
                    alert('‚úÖ NUEVO REGISTRO GUARDADO CORRECTAMENTE');
                } else {
                    await db.collection('registros').doc(documentoIdActual).update({
                        datosGenerales: datosGenerales,
                        registros: tiendas.map(t => ({
                            tienda: t.tienda,
                            cantidadBitacora: t.cantidadBitacora,
                            diferencia: t.diferencia,
                            cantidadFisica: t.cantidadFisica,
                            tipo: t.tipo
                        })),
                        resumen: resumen,
                        totales: {
                            dominos: totalDominos.toString(),
                            starbucks: totalStarbucks.toString()
                        },
                        validacion: validacionData
                    });
                    alert('‚úÖ VALIDACI√ìN GUARDADA CORRECTAMENTE');
                }

                ocultarLoader();
                limpiarTodoDespuesGuardar();

            } catch (e) { 
                ocultarLoader(); 
                alert('‚ùå ERROR: ' + e.message); 
            }
        }

        function obtenerTurnoActual() {
            const ahora = new Date();
            const hora = ahora.getHours() + ahora.getMinutes() / 60;
            if (hora >= 6 && hora < 14) return 'PRIMERO';
            if (hora >= 14 && hora < 21.5) return 'SEGUNDO';
            return 'TERCERO';
        }

        function mostrarLoader(m) { 
            document.querySelector('.loader-text').textContent = (m || 'PROCESANDO...').toUpperCase(); 
            document.getElementById('loaderOverlay').style.display = 'flex'; 
        }
        function ocultarLoader() { document.getElementById('loaderOverlay').style.display = 'none'; }
        function mostrarError(m) { 
            document.getElementById('mensajeError').textContent = m.toUpperCase(); 
            document.getElementById('mensajeError').style.display = 'block'; 
        }
        function ocultarError() { document.getElementById('mensajeError').style.display = 'none'; }
    </script>
</body>
</html>
