<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Ventanilla - Validador de Charolas</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
        :root {
            --primary:#0A2342; --secondary:#2C4C6B; --accent:#4A89C5; --light:#F5F9FF;
            --white:#fff; --gray:#E8EEF2; --text-dark:#1E2B3C; --success:#27AE60;
            --danger:#E74C3C; --warning:#F39C12; --border-radius:6px;
        }
        body { background:var(--gray); color:var(--text-dark); line-height:1.3; padding:12px; min-height:100vh; }
        .container {
            max-width:1400px; margin:0 auto; background:var(--white); border-radius:var(--border-radius);
            box-shadow:0 2px 6px rgba(10,35,66,0.08); padding:15px; display:flex; flex-direction:column;
            height:calc(100vh - 24px);
        }
        .header-fijo { flex-shrink:0; background:var(--white); padding-bottom:6px; border-bottom:2px solid var(--accent); margin-bottom:8px; }
        .header-superior { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
        .header-left { display:flex; align-items:center; gap:10px; }
        .logo-small { height:35px; width:auto; }
        .header-left h1 { color:var(--primary); font-size:1.2rem; }
        .header-left h1 span { color:var(--accent); font-weight:300; }
        .header-derecha { display:flex; align-items:center; gap:10px; }
        .user-info { display:flex; align-items:center; gap:12px; background:var(--light); padding:4px 12px; border-radius:30px; border-left:4px solid var(--accent); }
        .user-empleado { font-weight:600; color:var(--primary); font-size:0.8rem; }
        .btn-validar-header { background:var(--warning); color:white; border:none; border-radius:5px; padding:6px 18px; font-weight:700; font-size:0.8rem; text-transform:uppercase; cursor:pointer; }
        .btn-validar-header:hover { background:#E67E22; }
        .btn-validar-header:disabled { background:#95A5A6; cursor:not-allowed; }
        .btn { padding:4px 10px; border:none; border-radius:5px; font-weight:600; font-size:0.7rem; text-transform:uppercase; cursor:pointer; }
        .btn-primary { background:var(--primary); color:white; }
        .btn-danger { background:var(--danger); color:white; }
        .form-principal { background:linear-gradient(to right,var(--light),var(--white)); padding:8px 12px; border-radius:8px; margin-bottom:8px; border:1px solid rgba(74,137,197,0.15); }
        .fila-campos { display:grid; grid-template-columns:1.2fr 0.9fr 0.9fr 0.7fr 0.9fr 0.9fr 0.9fr; gap:6px; align-items:center; margin-bottom:6px; }
        .campo-group { display:flex; flex-direction:column; }
        .campo-group label { font-weight:600; color:var(--primary); margin-bottom:1px; font-size:0.6rem; text-transform:uppercase; }
        .campo-group input, .campo-group .valor { padding:4px 8px; border:1.5px solid var(--gray); border-radius:5px; font-size:0.8rem; background:var(--white); height:30px; }
        .campo-group .valor { background:#F0F4F8; display:flex; align-items:center; }
        .campo-group.check-group { display:flex; flex-direction:column; gap:4px; }
        .campo-group.check-group label { display:flex; align-items:center; gap:4px; font-size:0.7rem; text-transform:none; }
        .busqueda-integrada { display:flex; gap:3px; align-items:flex-end; }
        .busqueda-integrada .campo-group { flex:1; }
        .btn-lupa { background:var(--accent); color:white; border:none; border-radius:5px; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:0.9rem; }
        .fila-comentario { margin-top:6px; display:grid; grid-template-columns:1fr 3fr; gap:6px; }
        .validado-message { background:rgba(39,174,96,0.1); color:var(--success); padding:6px 12px; border-radius:5px; border-left:4px solid var(--success); margin-bottom:10px; font-weight:600; font-size:0.8rem; }
        .mensaje-error { color:var(--danger); font-size:0.75rem; margin:8px 0; padding:6px 10px; background:rgba(231,76,60,0.05); border-radius:5px; border-left:4px solid var(--danger); }
        .tabla-section { margin-top:10px; }
        .table-responsive { overflow-x:auto; border-radius:6px; border:1px solid var(--gray); }
        table { width:100%; border-collapse:collapse; table-layout:auto; min-width:1200px; }
        th { background:var(--primary); color:white; padding:6px 4px; font-size:0.65rem; text-transform:uppercase; text-align:center; }
        td { padding:5px 4px; border-bottom:1px solid var(--gray); text-align:center; font-size:0.75rem; }
        .table-input { width:100%; padding:4px 6px; border:1.5px solid var(--gray); border-radius:4px; font-size:0.75rem; text-align:center; background:var(--white); }
        .table-input:disabled { background:#F0F4F8; border-color:#D5DBDB; }
        .badge { padding:2px 6px; border-radius:50px; font-weight:600; font-size:0.6rem; display:inline-block; }
        .badge-dominos { background:rgba(0,165,176,0.1); color:#00A5B0; border:1px solid #00A5B0; }
        .badge-starbucks { background:rgba(0,98,65,0.1); color:#006241; border:1px solid #006241; }
        .loader-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(10,35,66,0.7); display:none; justify-content:center; align-items:center; z-index:20000; }
        .loader-container { background:white; padding:15px 25px; border-radius:10px; text-align:center; }
        .loader-spinner { width:35px; height:35px; border:3px solid var(--light); border-top:3px solid var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        .footer { margin-top:10px; color:var(--secondary); font-size:0.6rem; text-align:right; border-top:1px solid var(--gray); padding-top:6px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-fijo">
            <div class="header-superior">
                <div class="header-left">
                    <img src="logo.png" class="logo-small" onerror="this.style.display='none'">
                    <h1>Ventanilla de <span>Validaci√≥n</span></h1>
                </div>
                <div class="header-derecha">
                    <div class="user-info" id="userInfo" style="display:none;">
                        <span class="user-empleado" id="userEmpleado"></span>
                        <button class="btn btn-danger" onclick="cerrarSesion()">SALIR</button>
                    </div>
                    <div id="loginButtons">
                        <button class="btn btn-primary" onclick="window.location.href='login.html'">ACCEDER</button>
                    </div>
                    <button class="btn-validar-header" id="btnValidar" onclick="guardarValidacion()">‚úÖ VALIDAR</button>
                </div>
            </div>
            <div class="form-principal">
                <div class="fila-campos">
                    <!-- Col 1: B√∫squeda -->
                    <div class="busqueda-integrada">
                        <div class="campo-group"><label>üîç BIT√ÅCORA</label><input type="text" id="buscarBitacora" placeholder="N√∫mero" onkeypress="if(event.key==='Enter'){buscarRegistro();}"></div>
                        <button class="btn-lupa" onclick="buscarRegistro()">üîç</button>
                    </div>
                    <!-- Col 2: TRANSPORTE (antes era validador) -->
                    <div class="campo-group"><label>TRANSPORTE</label><input type="text" id="transporte" placeholder="Transporte"></div>
                    <!-- Col 3: CHECKBOX en columna -->
                    <div class="campo-group check-group">
                        <label><input type="checkbox" id="firmada" checked> FIRMADA</label>
                        <label><input type="checkbox" id="sellada" checked> SELLADA</label>
                    </div>
                    <!-- Col 4: FECHA -->
                    <div class="campo-group"><label>FECHA</label><input type="date" id="fechaBitacora"></div>
                    <!-- Col 5: OPERADOR -->
                    <div class="campo-group"><label>OPERADOR</label><input type="text" id="noOperador" placeholder="Operador"></div>
                    <!-- Col 6: VIAJE -->
                    <div class="campo-group"><label>VIAJE</label><input type="text" id="noViaje" placeholder="Viaje"></div>
                    <!-- Col 7: BOLETA (movida aqu√≠) -->
                    <div class="campo-group"><label>BOLETA</label><input type="text" id="boleta" placeholder="Boleta"></div>
                </div>
                <div class="fila-comentario">
                    <div class="campo-group"><label>COMENTARIOS</label><input type="text" id="comentariosValidacion" placeholder="Observaciones de validaci√≥n"></div>
                </div>
            </div>
        </div>
        <div style="flex:1; overflow-y:auto; padding-right:5px;">
            <div id="validadoMessage" class="validado-message" style="display:none;">‚úÖ Esta bit√°cora ya fue validada</div>
            <div id="mensajeError" class="mensaje-error" style="display:none;"></div>
            <div class="form-principal" id="datosBitacora" style="display:none;">
                <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:6px;">
                    <div class="campo-group"><label>NO. EMPLEADO</label><div class="valor" id="verNoEmpleado">‚Äî</div></div>
                    <div class="campo-group"><label>RUTA</label><div class="valor" id="verRuta">‚Äî</div></div>
                    <div class="campo-group"><label>BIT√ÅCORA</label><div class="valor" id="verBitacora">‚Äî</div></div>
                    <div class="campo-group"><label>UNIDAD</label><div class="valor" id="verUnidad">‚Äî</div></div>
                </div>
            </div>
            <div id="tablaSection" style="display:none;" class="tabla-section">
                <h3>üìã VALIDACI√ìN DE TIENDAS</h3>
                <div class="table-responsive">
                    <table id="tablaTiendas"><thead><tr><th>CECO</th><th>NOMBRE TIENDA</th><th>MARCA</th><th>REMISI√ìN</th><th>COMPLEMENTO</th><th>CANTIDAD</th><th>DIFERENCIA</th><th>CNT. F√çSICA</th></tr></thead><tbody id="tablaBody"></tbody></table>
                </div>
            </div>
        </div>
        <div class="footer">Sistema de Validaci√≥n V2.0 | E.Lugo 2026</div>
    </div>
    <div id="loaderOverlay" class="loader-overlay"><div class="loader-container"><div class="loader-spinner"></div><div class="loader-text">Procesando...</div></div></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDD0lCq8rAnCm2KjsqSwzxlpUhQU2gRVfk",
            authDomain: "registro-charolas.firebaseapp.com",
            projectId: "registro-charolas",
            storageBucket: "registro-charolas.firebasestorage.app",
            messagingSenderId: "105080206085",
            appId: "1:105080206085:web:443ba22aaf8cbcea767d6c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let registroActual = null, documentoIdActual = null, datosOrganigrama = [], esModoEdicion = true;

        // MOSTRAR USUARIO DESDE SESSIONSTORAGE
        document.addEventListener('DOMContentLoaded', function() {
            const nombre = sessionStorage.getItem('usuarioNombre');
            const emp = sessionStorage.getItem('usuarioEmpleado');
            if (nombre) document.getElementById('userEmpleado').textContent = nombre;
            else if (emp) document.getElementById('userEmpleado').textContent = emp;
            else document.getElementById('userEmpleado').textContent = 'Usuario';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('loginButtons').style.display = 'none';
            cargarOrganigrama();
        });

        function cerrarSesion() { sessionStorage.clear(); window.location.href = 'login.html'; }

        async function cargarOrganigrama() {
            try {
                const snap = await db.collection('organigrama').doc('lista_cecos').get();
                if (snap.exists) datosOrganigrama = snap.data().datosCompletos || [];
            } catch (e) { datosOrganigrama = []; }
        }

        function obtenerDatosTienda(ceco) {
            if (!datosOrganigrama.length) return { nombre: '', marca: '' };
            const t = datosOrganigrama.find(i => String(i.ceco).trim() === String(ceco).trim());
            return t ? { nombre: t.tienda || '', marca: t.marca || '' } : { nombre: '', marca: '' };
        }

        async function buscarRegistro() {
            const bit = document.getElementById('buscarBitacora').value.trim();
            if (!bit) { mostrarError('‚ö†Ô∏è Ingresa n√∫mero'); return; }
            mostrarLoader();
            try {
                const snap = await db.collection('registros').where('datosGenerales.bitacora', '==', bit).get();
                if (snap.empty) {
                    ocultarLoader(); mostrarError('‚ùå No encontrado'); ocultarTodo();
                    registroActual = null; documentoIdActual = null; return;
                }
                snap.forEach(d => { registroActual = d.data(); documentoIdActual = d.id; });
                if (registroActual.validacion) {
                    esModoEdicion = false; document.getElementById('validadoMessage').style.display = 'block';
                    document.getElementById('btnValidar').disabled = true; bloquearCampos(true);
                    cargarDatosValidacion(registroActual);
                } else {
                    esModoEdicion = true; document.getElementById('validadoMessage').style.display = 'none';
                    document.getElementById('btnValidar').disabled = false; bloquearCampos(false);
                }
                mostrarRegistro(registroActual); ocultarError();
            } catch (e) { mostrarError('‚ùå Error: ' + e.message); } finally { ocultarLoader(); }
        }

        function bloquearCampos(b) {
            ['transporte','firmada','sellada','fechaBitacora','noOperador','noViaje','boleta','comentariosValidacion']
                .forEach(id => { const el = document.getElementById(id); if(el) el.disabled = b; });
        }

        function mostrarRegistro(r) {
            document.getElementById('verNoEmpleado').textContent = r.datosGenerales?.noEmpleado||'S/N';
            document.getElementById('verRuta').textContent = r.datosGenerales?.ruta||'S/N';
            document.getElementById('verBitacora').textContent = r.datosGenerales?.bitacora||'S/N';
            document.getElementById('verUnidad').textContent = r.datosGenerales?.unidad||'S/N';
            document.getElementById('datosBitacora').style.display = 'block';
            document.getElementById('tablaSection').style.display = 'block';

            const tbody = document.getElementById('tablaBody');
            tbody.innerHTML = '';
            if (r.registros && r.registros.length) {
                r.registros.forEach((t, i) => {
                    const d = obtenerDatosTienda(t.tienda);
                    const badge = (d.marca||'').toUpperCase().includes('DOMINO') ? 'badge-dominos' : 'badge-starbucks';
                    const rem = r.validacion?.tiendas?.[i]?.remision||'';
                    const com = r.validacion?.tiendas?.[i]?.complemento||'';
                    tbody.innerHTML += `<tr>
                        <td>${t.tienda||''}</td>
                        <td>${d.nombre||''}</td>
                        <td><span class="badge ${badge}">${d.marca||''}</span></td>
                        <td><input type="text" class="table-input" value="${rem}" placeholder="Remisi√≥n" id="remision_${i}" ${!esModoEdicion?'disabled':''}></td>
                        <td><input type="text" class="table-input" value="${com}" placeholder="Complemento" id="complemento_${i}" ${!esModoEdicion?'disabled':''}></td>
                        <td>${t.cantidadBitacora||0}</td>
                        <td>${t.diferencia||0}</td>
                        <td><strong>${t.cantidadFisica||0}</strong></td>
                    </tr>`;
                });
            }
            if (r.validacion) cargarDatosValidacion(r);
        }

        function cargarDatosValidacion(r) {
            if (r.validacion) {
                document.getElementById('transporte').value = r.validacion.transporte||'';
                document.getElementById('firmada').checked = r.validacion.firmada||false;
                document.getElementById('sellada').checked = r.validacion.sellada||false;
                document.getElementById('fechaBitacora').value = r.validacion.fechaBitacora||'';
                document.getElementById('noOperador').value = r.validacion.noOperador||'';
                document.getElementById('noViaje').value = r.validacion.noViaje||'';
                document.getElementById('boleta').value = r.validacion.boleta||'';
                document.getElementById('comentariosValidacion').value = r.validacion.comentarios||'';
            }
        }

        async function guardarValidacion() {
            if (!documentoIdActual) { alert('‚ùå Primero busca una bit√°cora'); return; }
            if (!esModoEdicion) { alert('‚ùå Ya validada'); return; }
            mostrarLoader('Guardando...');
            try {
                const tiendas = [];
                document.querySelectorAll('#tablaBody tr').forEach((f,i) => {
                    tiendas.push({
                        remision: document.getElementById(`remision_${i}`)?.value||'',
                        complemento: document.getElementById(`complemento_${i}`)?.value||''
                    });
                });

                // Obtener nombre del usuario logueado
                const nombreValidador = sessionStorage.getItem('usuarioNombre') || sessionStorage.getItem('usuarioEmpleado') || 'Validador';
                const fechaActual = new Date().toLocaleString();

                // Comentario combinado: respeta el existente + el nuevo de ventanilla
                const comentarioExistente = registroActual?.datosGenerales?.comentarios || '';
                const comentarioNuevo = document.getElementById('comentariosValidacion').value.trim();
                
                let comentarioFinal = '';
                if (comentarioExistente && comentarioNuevo) {
                    comentarioFinal = `${comentarioExistente} | [Validaci√≥n ${fechaActual} por ${nombreValidador}: ${comentarioNuevo}]`;
                } else if (comentarioNuevo) {
                    comentarioFinal = `[Validaci√≥n ${fechaActual} por ${nombreValidador}: ${comentarioNuevo}]`;
                } else {
                    comentarioFinal = comentarioExistente;
                }

                const validacionData = {
                    validador: nombreValidador,  // Autom√°tico desde sesi√≥n
                    transporte: document.getElementById('transporte').value.trim() || '',
                    firmada: document.getElementById('firmada').checked,
                    sellada: document.getElementById('sellada').checked,
                    fechaBitacora: document.getElementById('fechaBitacora').value || '',
                    noOperador: document.getElementById('noOperador').value.trim() || '',
                    noViaje: document.getElementById('noViaje').value.trim() || '',
                    boleta: document.getElementById('boleta').value.trim() || '',
                    comentarios: comentarioNuevo,  // Comentario de validaci√≥n aparte
                    tiendas: tiendas,
                    fechaValidacion: fechaActual,
                    validadoPor: nombreValidador
                };

                await db.collection('registros').doc(documentoIdActual).update({
                    validacion: validacionData,
                    'datosGenerales.comentarios': comentarioFinal  // Actualizar el campo de comentarios combinado
                });

                ocultarLoader(); alert('‚úÖ Validaci√≥n guardada');
                esModoEdicion = false;
                document.getElementById('validadoMessage').style.display = 'block';
                document.getElementById('btnValidar').disabled = true;
                bloquearCampos(true);

            } catch (e) { ocultarLoader(); alert('‚ùå Error: ' + e.message); }
        }

        function mostrarLoader() { document.getElementById('loaderOverlay').style.display = 'flex'; }
        function ocultarLoader() { document.getElementById('loaderOverlay').style.display = 'none'; }
        function mostrarError(m) { document.getElementById('mensajeError').textContent = m; document.getElementById('mensajeError').style.display = 'block'; }
        function ocultarError() { document.getElementById('mensajeError').style.display = 'none'; }
        function ocultarTodo() {
            document.getElementById('datosBitacora').style.display = 'none';
            document.getElementById('tablaSection').style.display = 'none';
            document.getElementById('validadoMessage').style.display = 'none';
        }
    </script>
</body>
</html>
